\newpage

# Дизайн и архитектура

## Где устанавливать Barman

Одной из основных возможностей Barman является способность работать с серверами базы данных через сеть.

Теоретически, вы могли бы разместить свой сервер Barman в центре обработки данных в другой части мира, за тысячи километров от вашего сервера PostgreSQL.

В реальности разнесение сервера Barman и сервера PostgreSQL на большое расстояние влечет увеличение времени резервного копирования и восстановления.

Несмотря на то, что не существует метода настройки Barman подходящего всем, есть несколько рекомендаций, которые мы предлагаем вам соблюдать, в частности:

- Установите Barman на выделенный сервер
- Не используйте одно и то же хранилище для сервера PostgreSQL и для резервных копий
- Интегрируйте Barman с вашей инфраструктурой мониторинга [^ nagios]
- Проверяйте все, прежде чем использовать в продуктивной среде

  [^nagios]: Интеграция с Nagios / Icinga проста благодаря команде «barman check --nagios», одной из самых важных функций бармена.

Разумным способом начать моделирование архитектуры аварийного восстановления является:

- разработать несколько возможных сценариев расположения PostgreSQL и Barman, таких как:
     1. тот же центр обработки данных
     2. другой центр обработки данных (соседний)
     3. другой центр обработки данных
- разработать плюсы и минусы каждой гипотезы
- оценить отдельные точки отказа (SPOF) вашей системы, с анализом затрат и результатов
- принять решение и реализовать его

Как уже было сказано, самая простая схема для Barman это установка в том же центре обработки данных что и ваши серверы PostgreSQL. В этом случае единственной точкой отказа является центр обработки данных. К счастью, влияние такого SPOF можно облегчить благодаря функции, называемой _hook scripts_. Действительно, резервные копии Barman могут быть экспортированы на разных носителях, таких как _tape_ через «tar» или хранилища, например, _S3 bucket_ в облаке Amazon.

Помните, что выбранное решение не навсегда. Вы можете начать с простого и со временем изменять настройки, выбрав те которые вам подходят лучше всего.

## Один Barman, много серверов PostgreSQL

Еще одна важная функция, впервые введенная Barman, - это поддержка нескольких серверов. Бармен может централизованно хранить резервные копии, поступающие из нескольких экземпляров PostgreSQL, даже с разными версиями. [^recver]

   [^recver]: Такие же [требования для PITR PostgreSQL] [requirements_recovery] применяются для восстановления, как описано в разделе _"Требования к восстановлению"_.

В результате вы можете моделировать сложные архитектуры аварийного восстановления, формируя «звездную схему», где серверы PostgreSQL вращаются вокруг центрального сервера Barman.

Каждая архитектура имеет свой смысл. Выберите тот, который нравится вам, и, самое главное, тот, которому вы доверяете, на основе реальных экспериментов и тестирования.

С этой точки зрения, для простоты, это руководство возьмет на себя основную архитектуру:

- один экземпляр PostgreSQL (с именем хоста `pg`)
- один резервный сервер с Barman (с именем хоста `backup`)

## Потоковое резервное копирование vs rsync/SSH

Традиционно, Barman всегда работал удаленно через SSH, используя `rsync` для физических операций резервного копирования. Версия 2.0 представляет встроенную поддержку протокола потоковой репликации PostgreSQL для операций резервного копирования через `pg_basebackup`. [^fmatrix]

   [^fmatrix]: см. "Feature matrix", в которой указано какие версии PostgreSQL поддерживают потоковое резервное копироание с помощью Barman.

Выбор одного из этих двух методов - это решение, которое вам нужно будет сделать.

На общем основании, начиная с Barman 2.0, резервная копия по потоковой репликации является рекомендуемой установкой для PostgreSQL 9.4 или выше. Более того, если вы не используете табличные пространства, можно использовать резервное копирование поверх потоковой передачи, начиная с PostgreSQL 9.2.


> **Важно:** \newline
> Поскольку Barman прозрачно использует `pg_basebackup`, такие функции, как инкрементное резервное копирование, дедупликация и сетевое сжатие, в настоящее время недоступны. В этом случае ограничение полосы пропускания имеет некоторые ограничения - по сравнению с традиционным методом через `rsync`.

Традиционная резервная копия через `rsync` / SSH доступна для всех версий PostgreSQL, начиная с 8.3, и рекомендуется во всех случаях, где существуют ограничения` pg_basebackup` (например, очень большая база данных, которая может выиграть от инкрементного резервного копирования и дедупликации).

Причина, по которой мы рекомендуем потоковое резервное копирование, состоит в том, что, основываясь на нашем опыте, его проще настроить, чем традиционный. Кроме того, потоковая резервная копия позволяет вам создавать резервные копии сервера PostgreSQL в Windows [^windows] и облегчает жизнь при работе с Docker.

  [^windows]: Резервное копирование сервера PostgreSQL в Windows возможно, но оно все еще экспериментально, потому что оно еще не является частью нашей системы непрерывной интеграции. Подробнее см. В разделе _"Как настроить сервер на базе Windows"_.

## Стандартное архивирование, потоковая передача WAL или оба варианта вместе.

PITR для PostgreSQL требует, чтобы транзакционные журналы, также известные как _xlog_ или WAL-файлы, сохранялись вместе с базовыми резервными копиями.

Традиционно Barman поддерживал стандартную доставку WAL-файлов через `archive_command` PostgreSQL (обычно через `rsync` / SSH). С помощью этого метода файлы WAL архивируются только тогда, когда произойдет _переключение_ PostgreSQL на новый WAL-файл. Обычно это происходит каждые 16 МБ данных.

Barman с версии 1.6.0 позволяет организовать потоковую передачу WAL-файлов через `pg_receivexlog` для серверов PostgreSQL версии 9.2 или новее в качестве дополнительного метода для архивирования журналов транзакций. Потоковая передача WAL-файлов способна снизить риск потери данных, приведя RPO близким к нулю.

Barman 2.0 поддерживает слоты репликации с серверами PostgreSQL 9.4 или выше, это позволяет обойтись только потоковой передачей. Кроме того, теперь вы можете добавить Barman в качестве синхронного приемника WAL в своем кластере PostgreSQL 9.5 (или выше) и добиться **нулевой потери данных** (RPO = 0).

В некоторых случаях у вас нет выбора, и вы вынуждены использовать традиционное архивирование. В других случаях вы можете выбрать, использовать ли оба метода или только потоковую передачу.
Если у вас нет серьезных причин не делать этого, мы рекомендуем использовать оба канала для максимальной надежности.

## Два типичных сценария для резервного копирования

Чтобы облегчить вам жизнь, ниже мы кратко опишем два наиболее типичных сценария работы с Barman.

Имейте в виду, что это решение, которое вы должны сделать для каждого отдельного сервера, который вы решили резервировать с помощью Barman. Это означает, что вы можете иметь гетерогенные настройки в рамках одной и той же установки.

Как упоминалось ранее, мы будем использовать только сервер PostgreSQL (`pg`) и сервер Barman (` backup`). Однако в реальной жизни ваша архитектура, скорее всего, будет содержать другие технологии, такие как repmgr, pgBouncer, Nagios/Icinga и т.д.

### Сценарий 1: Резервное копирование по протоколу потоковой передачи

Если вы используете PostgreSQL 9.4 или выше, и ваша база данных попадает в общий сценарий использования, скорее всего, вы решите установить потоковое резервное копирование - см. Рисунок \ref{script1-design} ниже.

<!-- TODO: Этот способ ссылок не будет работать в HTML -->
! [Резервное копирование с помощью потоковой передачи (сценарий 1)\label{script1-design}](../images/barman-architecture-scene1.png){width = 80%}

В этом случае вам необходимо настроить:

1. стандартное подключение к PostgreSQL для целей управления, координации и мониторинга
2. соединение потоковой репликации, которое будет использоваться и как `pg_basebackup` (для операций резервного копирования), так и `pg_receivexlog` (для потоковой передачи WAL)

Эта настройка в терминологии Barman звучит как **потоковая настройка**, так как она не требует SSH-соединения для операций резервного копирования и архивирования. Это особенно удобно и чрезвычайно практично в среде Docker.

Однако, как упоминалось ранее, вы можете также настроить стандартное архивирование и внедрить более надежную архитектуру - см. Рисунок \ref{script1b-design} ниже.

![Потоковая резервная копия с архивированием WAL (сценарий 1b)\label{script1b-design}](../images/barman-architecture-scene1b.png) {width = 80%}

Этот альтернативный подход требует:

- дополнительное SSH-соединение, которое позволяет пользователю postgres на сервере PostgreSQL подключаться как пользователь barman на сервере Barman
- команда «archive_command» в PostgreSQL настроена на отправку файлов WAL в Barman

Эта архитектура доступна также пользователям PostgreSQL 9.2 / 9.3, которые не используют табличные пространства.

### Сценарий 2: Резервное копирование через `rsync`/SSH

Это _обычная_ настройка `rsync` через SSH является единственной доступной опцией для:

- Серверов PostgreSQL версии 8.3, 8.4, 9.0 или 9.1
- Серверов PostgreSQL версии 9.2 или 9.3, которые используют табличные пространства
- Инкрементного резервного копирования и дедупликации
- Сжатие данных при передаче по сети во время резервного копирования
- Более тонкое управление использованием полосы пропускания, в том числе на основе табличного пространства

![Сценарий 2 - Резервное копирование через rsync/SSH] (../images/barman-architecture-scene2.png){width = 80%}

В этом случае вам необходимо настроить:

1. стандартное подключение к PostgreSQL для целей управления, координации и мониторинга
2. SSH-соединение для базовых операций резервного копирования, которое будет использоваться `rsync`, что позволяет пользователю `barman` с сервера Barman подключаться как пользователь `postgres` на сервере PostgreSQL
3. SSH-соединение для архивации WAL, которое будет использоваться командой `archive_command` в PostgreSQL, и которое позволяет пользователю postgres на сервере PostgreSQL подключаться как пользователь `barman` на сервере Barman.

Начиная с PostgreSQL 9.2 вы можете добавить потоковое репликационное соединение, которое используется для потоковой передачи WAL и значительно сократить RPO. Эта более надежная реализация изображена на рисунке \ref{script2b-design}.

![Резервное копирование через rsync/SSH с потоковой передачей WAL-файлов (сценарий 2b) \label{script2b-design}](../images/barman-architecture-scene2b.png){width = 80%}

<!-- TODO - Добавить раздел об архитектуре для восстановления? -->
