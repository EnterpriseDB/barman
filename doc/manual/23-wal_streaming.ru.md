## Потоковая передача WAL

Потоковая передача журналов транзакций в дополнении к стандартной
процедуре архивирования журналов позволяет уменьшить RPO.

Barman опирается на [`pg_receivexlog`] [25], утилиту, которая стала
доступна в PostgreSQL версии 9.2. Она использует собственный протокол
потоковой репликации и непрерывно получает журналы транзакций с сервера
PostgreSQL (основного или резервного).

> **Внимание:**
> Утилита `pg_receivexlog` должна быть установлена на том же сервере
> что и Barman. Для серверов PostgreSQL версии 9.2 вам понадобится
> `pg_receivexlog` версии 9.2. Для PostgreSQL версии 9.3 и выше
> рекомендуется установить последнюю доступную версию `pg_receivexlog`,
> так как они обратно совместимы. В качестве альтернативы можно установить
> несколько версий файла `pg_receivexlog` на сервере Barman и правильно
> указать конкретную версию для сервера, используя опцию` path_prefix`
> в файле конфигурации.

Для включения потоковой передачи журналов транзакций необходимо:

1. настроить потоковое соединение, как описано выше
2. установить для параметра `streaming_archiver` значение` on`

Если вышеупомянутые требования выполнены, команда `cron`,
прозрачно управляет потоком журнала через выполнение `Receive-wal`.
Это рекомендуемый сценарий.

Однако, можно вручную выполнить команду `receive-wal`:

``` bash
barman receive-wal <server_name>
```

> **Замечание:**
> Комманда `receive-wal` работает в фоновом режиме.

Журналы транзакций транслируются непосредственно в каталог, указанный
параметром конфигурации `streaming wals directory`, и затем
архивируются командой `archive-wal`.

Если иное не указано в параметре `streaming_archiver_name` и только для
PostgreSQL 9.3 или выше, Barman установит `application_name` процесса
потокой передачи WAL на `barman_receive_wal`, что позволит вам
отслеживать его статус в системном представлении pg_stat_replication`
сервера PostgreSQL

### Слоты репликации

> ** ВАЖНО: ** слоты репликации доступны в PostgreSQL версии 9.4

Слоты репликации - обеспечивают механизм сохранения сегментов WAL,
таким образом что сервер PostgreSQL не удалит файлы WAL, пока они
не будут получены всеми архиваторами. Barman использует этот
механизм для получения журналов транзакций из PostgreSQL.

Более подробную информацию о слотах репликации смотри в руководстве
[PostgreSQL] [replication-slots].

Вы можете даже основывать свою архитектуру резервного копирования
только на потоковом подключении. Этот сценарий полезен для настройки
серверов PostgreSQL на основе Docker и даже для работы с серверами
PostgreSQL, работающими в Windows.

> ** ВАЖНО: **
> В настоящий момент поддержка Windows по-прежнему остается
экспериментальной, поскольку она еще не является частью нашей
системы непрерывной интеграции.

### Настройка потоковой репликации

Настройте сервер СУБД на передачу WAL файлов серверу Barman.

Для настройки потокового соединения от сервера Barman к PostgreSQL
необходимо активировать параметр `streaming_archiver` в файле
конфигурации сервера СУБД:

``` ini
streaming_archiver = on
```
Если планируется использовать слоты репликации (рекомендуется),
нужно задать значение параметра `slot_name`:

``` ini
slot_name = barman
```

Этот параметр определяет имя слота репликации, который будет
использоваться Barman. Это обязательно, если вы хотите
использовать слоты репликации.

После настройки имени слота репликации вы можете создать слот
репликации для Barman с помощью следующей команды:

``` bash
barman@backup$ barman receive-wal --create-slot pg
Creating physical replication slot 'barman' on server 'pg'
Replication slot 'barman' created
```

