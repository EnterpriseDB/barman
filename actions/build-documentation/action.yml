name: Generate Documentation
description: |
  Create documentation for barman


inputs:
  docker-image:
    description: docker image to use. will build it if not provided
    required: false

  barman-path:
    description: path for barman
    required: false
    default: barman


runs:
  using: "composite"
  steps:
    - name: build docker image
      if: "!inputs.docker-image"
      run: |
        docker build ${{ inputs.barman-path }}/doc -t barman-pandoc
        echo "PANDOC_IMAGE=barman-pandoc" >> $GITHUB_ENV
      shell: bash

    - name: pull docker image
      if: "inputs.docker-image"
      run: |
        docker pull ${{ inputs.docker-image }} barman-pandoc
        echo "PANDOC_IMAGE=${{ inputs.docker-image }}" >> $GITHUB_ENV
      shell: bash

    - name: build doc
      run: |
        cd ${{ inputs.barman-path }}/doc/build
        ./build
      shell: bash
      env:
        BASEDIR: ${{ inputs.barman-path }}
        PANDOC_IMAGE: ${{ env.PANDOC_IMAGE }}
    - name: check output
      run: |
        ls ${{ inputs.barman-path }}/doc/dist
      shell: bash
    - name: Upload pdf documentation
      uses: actions/upload-artifact@v3
      with:
        name: manual.pdf
        path: ${{ inputs.barman-path }}/doc/dist/manual.pdf
        if-no-files-found: error
    - name: Upload html documentation
      uses: actions/upload-artifact@v3
      with:
        name: documentation
        path: ${{ inputs.barman-path }}/doc/dist
        if-no-files-found: error
